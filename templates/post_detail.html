{% extends 'base.html' %}
{% block content %}
<div class="min-h-screen bg-gray-100 dark:bg-gray-900 transition-colors duration-300">
    <div class="container mx-auto p-4">
        <!-- Timeline Section -->
        {% if revisions %}
        <div class="relative mb-6">
            <div class="absolute w-full h-1 bg-gray-300 dark:bg-gray-700 top-1/2 transform -translate-y-1/2"></div>
            <div class="flex items-center justify-start space-x-4 relative z-10"> <!-- Reduced spacing with space-x-4 -->
                {% for rev in revisions %}
                <div class="group flex flex-col items-center">
                    <div class="w-3 h-3 rounded-full border-2 border-blue-500 cursor-pointer transition-all duration-200 revision-dot"
                         data-rev-id="{{ rev.id }}"
                         data-content="{{ rev.content }}"
                         data-caption="{{ rev.caption or 'None' }}"
                         data-file-path="{{ rev.file_path or 'None' }}"
                         data-schedule-date="{{ rev.schedule_date or 'None' }}"
                         data-revised-at="{{ rev.revised_at }}"
                         data-revised-by-id="{{ rev.revised_by_id }}"
                         data-index="{{ loop.index0 }}"
                         onclick="toggleRevision('{{ loop.index0 }}')"></div>
                    <div class="hidden group-hover:block absolute bg-gray-800 text-white text-xs rounded py-1 px-2 mt-2 -translate-x-1/2 left-1/2 whitespace-nowrap"
                         id="tooltip-{{ loop.index0 }}">{{ rev.revised_at }} by User ID {{ rev.revised_by_id }}</div>
                </div>
                {% endfor %}
            </div>
        </div>
        <style>
            /* Animation for content change */
            .fade-in {
                animation: fadeIn 0.5s ease-in-out;
            }
            @keyframes fadeIn {
                0% { opacity: 0; }
                100% { opacity: 1; }
            }
        </style>
        <script>
            let currentRevisionIdx = {{ revisions|length - 1 }};
            const revisions = {{ revisions | tojson | safe }};
            let contentElements;
            let dots;

            function toggleRevision(idx) {
                currentRevisionIdx = parseInt(idx);
                const rev = revisions[currentRevisionIdx];

                // Apply fade animation to content elements
                Object.values(contentElements).forEach(el => {
                    if (el) {
                        el.classList.remove('fade-in');
                        void el.offsetWidth; // Trigger reflow to restart animation
                        el.classList.add('fade-in');
                    }
                });

                // Update content elements
                if (contentElements.id) contentElements.id.textContent = rev.id;
                if (contentElements.content) contentElements.content.textContent = rev.content;
                if (contentElements.caption) {
                    contentElements.caption.textContent = `Caption: ${rev.caption || 'None'}`;
                    if (rev.caption) {
                        contentElements.caption.classList.remove('hidden');
                    } else {
                        contentElements.caption.classList.add('hidden');
                    }
                }
                if (contentElements.filePath) {
                    if (rev.file_path && rev.file_path !== 'None') {
                        let mediaHTML = '';
                        const filePath = rev.file_path;
                        if (filePath.endsWith('.png') || filePath.endsWith('.jpg') || filePath.endsWith('.jpeg') || filePath.endsWith('.gif')) {
                            mediaHTML = `<img src="/static/${filePath}" alt="Post Media" class="max-w-full h-auto rounded-lg">`;
                        } else if (filePath.endsWith('.mp4')) {
                            mediaHTML = `
                                <video controls class="max-w-full h-auto rounded-lg">
                                    <source src="/static/${filePath}" type="video/mp4">
                                    Your browser does not support the video tag.
                                </video>`;
                        } else {
                            mediaHTML = '<p>Unsupported media type.</p>';
                        }
                        contentElements.filePath.innerHTML = mediaHTML;
                        contentElements.filePath.classList.remove('hidden');
                    } else {
                        contentElements.filePath.innerHTML = '';
                        contentElements.filePath.classList.add('hidden');
                    }
                }
                if (contentElements.scheduleDate) {
                    contentElements.scheduleDate.textContent = `Schedule Date: ${rev.schedule_date || 'None'}`;
                    const header = contentElements.scheduleDate.previousElementSibling;
                    if (rev.schedule_date && rev.schedule_date !== 'None') {
                        contentElements.scheduleDate.classList.remove('hidden');
                        if (header && header.tagName === 'H3') header.classList.remove('hidden');
                    } else {
                        contentElements.scheduleDate.classList.add('hidden');
                        if (header && header.tagName === 'H3') header.classList.add('hidden');
                    }
                }

                // Update circle styles - Remove all backgrounds first, then apply selectively
                dots.forEach((dot, index) => {
                    dot.classList.remove('bg-blue-500', 'bg-transparent');
                    if (index === currentRevisionIdx) {
                        dot.classList.add('bg-blue-500');
                    } else {
                        dot.classList.add('bg-transparent');
                    }
                });
            }

            // Initialize with the latest revision
            document.addEventListener('DOMContentLoaded', () => {
                dots = document.querySelectorAll('.revision-dot');
                contentElements = {
                    id: document.querySelector('p[data-rev-id]'),
                    content: document.querySelector('p[data-content]'),
                    caption: document.querySelector('p[data-caption]'),
                    filePath: document.querySelector('div[data-file-path]'),
                    scheduleDate: document.querySelector('p[data-schedule-date]')
                };
                if (dots.length > 0) {
                    // Ensure initial state is set correctly
                    toggleRevision(currentRevisionIdx);
                }
            });
        </script>
        {% endif %}

        <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-200 mb-4">Post Details</h2>
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
            <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200">Post ID</h3>
            <p class="text-gray-600 dark:text-gray-400" data-rev-id>{{ post.id }}</p>
            <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mt-4">Client</h3>
            <p class="text-gray-600 dark:text-gray-400">{{ post.client.name }}</p>
            <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mt-4">Content</h3>
            <div class="text-gray-600 dark:text-gray-400">
                <p data-content>{{ post.content }}</p>
                <p class="mt-2 {% if not post.caption %}hidden{% endif %}" data-caption>Caption: {{ post.caption or 'None' }}</p>
                <div class="mt-2 {% if not post.file_path %}hidden{% endif %}" data-file-path>
                    {% if post.file_path %}
                    {% if post.file_path.endswith(('.png', '.jpg', '.jpeg', '.gif')) %}
                    <img src="{{ url_for('static', filename=post.file_path) }}" alt="Post Media" class="max-w-full h-auto rounded-lg">
                    {% elif post.file_path.endswith('.mp4') %}
                    <video controls class="max-w-full h-auto rounded-lg">
                        <source src="{{ url_for('static', filename=post.file_path) }}" type="video/mp4">
                        Your browser does not support the video tag.
                    </video>
                    {% else %}
                    <p>Unsupported media type.</p>
                    {% endif %}
                    {% endif %}
                </div>
            </div>
            <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mt-4">Status</h3>
            <p class="text-gray-600 dark:text-gray-400">{{ post.status | capitalize }}</p>
            <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mt-4">Created At</h3>
            <p class="text-gray-600 dark:text-gray-400">{{ post.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</p>
            <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mt-4 {% if not post.schedule_date %}hidden{% endif %}">Schedule Date</h3>
            <p class="text-gray-600 dark:text-gray-400 {% if not post.schedule_date %}hidden{% endif %}" data-schedule-date>Schedule Date: {{ post.schedule_date.strftime('%Y-%m-%d') if post.schedule_date else 'None' }}</p>
            <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mt-4">Approvals</h3>
            <ul class="list-disc pl-5 text-gray-600 dark:text-gray-400">
                {% for approval in post.approvals %}
                <li>{{ approval.user.username }}: {{ approval.status | capitalize }}</li>
                {% endfor %}
                {% if post.approvals|length == 0 %}
                <li>No approvers assigned.</li>
                {% endif %}
            </ul>
            {% if post.status == 'pending' and post.approvals|selectattr('user_id', 'equalto', current_user.id)|selectattr('status', 'equalto', 'pending')|list %}
            <form method="POST" class="mt-4">
                <button type="submit" name="action" value="approve" class="p-2 rounded-lg bg-green-600 text-white hover:bg-green-700 transition">Approve</button>
                <button type="submit" name="action" value="reject" class="p-2 rounded-lg bg-red-600 text-white hover:bg-red-700 transition ml-2">Reject</button>
            </form>
            {% endif %}
            
            <!-- Revision History Section (Removed Diff, Simplified) -->
            <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mt-6">Revision History</h3>
            {% if revisions %}
            <ul class="mt-4 space-y-4">
                {% for rev in revisions %}
                <li class="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                    <strong class="text-gray-800 dark:text-gray-200">Revision {{ loop.revindex }} by User ID {{ rev.revised_by_id }} on {{ rev.revised_at }}</strong>
                    <div class="mt-2 text-gray-600 dark:text-gray-400">
                        <p><strong>Content:</strong> {{ rev.content|truncate(100, true) }}</p>
                        <p><strong>Caption:</strong> {{ rev.caption or 'None' }}</p>
                        {% if rev.file_path %}
                        <p><strong>Media:</strong> <a href="{{ url_for('static', filename=rev.file_path) }}" target="_blank" class="text-blue-500 hover:underline">View File</a></p>
                        {% else %}
                        <p><strong>Media:</strong> None</p>
                        {% endif %}
                    </div>
                </li>
                {% endfor %}
            </ul>
            {% else %}
            <p class="text-gray-600 dark:text-gray-400 mt-2">No revisions yet.</p>
            {% endif %}

            <!-- Add a Revision Button and Modal -->
            {% if post.status in ['draft', 'pending', 'approved'] and post.client and post.client.user_id == current_user.id %}
            <button onclick="document.getElementById('edit-post-modal').classList.remove('hidden')" class="mt-4 p-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition">Add a Revision</button>
            
            <!-- Modal -->
            <div id="edit-post-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50">
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg w-full max-w-md">
                    <h3 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-4">Edit Post</h3>
                    <form method="POST" action="{{ url_for('edit_post', post_id=post.id) }}" enctype="multipart/form-data">
                        <label class="block mb-2 text-gray-600 dark:text-gray-400">Content</label>
                        <textarea name="content" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200" required>{{ post.content }}</textarea>
                        
                        <label class="block mt-4 mb-2 text-gray-600 dark:text-gray-400">Caption (Optional)</label>
                        <input type="text" name="caption" value="{{ post.caption or '' }}" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200">
                        
                        <label class="block mt-4 mb-2 text-gray-600 dark:text-gray-400">Schedule Date (Optional)</label>
                        <input type="date" name="schedule_date" value="{{ post.schedule_date.strftime('%Y-%m-%d') if post.schedule_date else '' }}" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200">
                        
                        <label class="block mt-4 mb-2 text-gray-600 dark:text-gray-400">Upload New Media (Optional, allowed: png, jpg, jpeg, gif, mp4)</label>
                        <input type="file" name="file" accept=".png,.jpg,.jpeg,.gif,.mp4" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200">
                        
                        <div class="mt-4 flex space-x-2">
                            <button type="submit" class="p-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition">Save Revision</button>
                            <button type="button" onclick="document.getElementById('edit-post-modal').classList.add('hidden')" class="p-2 rounded-lg bg-gray-600 text-white hover:bg-gray-700 transition">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
            {% else %}
            <p class="mt-4 text-gray-600 dark:text-gray-400">You do not have permission to add a revision.</p>
            {% endif %}
            
            <a href="{{ url_for('client_posts', client_id=post.client_id) }}" class="mt-4 inline-block p-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 transition">Back to Posts</a>
        </div>
    </div>
</div>
{% endblock %}